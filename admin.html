<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Bestell√ºbersicht</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <style>
    .password-screen {
      display: block;
    }
    .content {
      display: none;
    }
    .refresh-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      cursor: pointer;
      color: #007bff;
    }
    .refresh-btn:hover {
      color: #0056b3;
    }
  </style>
</head>
<body>

  <div class="password-screen text-center" id="password-screen">
    <div class="container">
      <h2>Admin Bereich - Passwort erforderlich</h2>
      <input type="password" id="password" class="form-control my-3" placeholder="Passwort eingeben" />
      <button class="btn btn-primary" onclick="checkPassword()">Zugang gew√§hren</button>
    </div>
  </div>

  <div class="content" id="admin-content">
    <div class="container my-5">
      <h1 class="text-center mb-4">üçΩÔ∏è Bestell√ºbersicht</h1>

      <div class="refresh-btn" onclick="fetchOrders()">
        <i class="fas fa-sync-alt"></i> Aktualisieren
      </div>

      <h3>üìã Alle Bestellungen von heute</h3>
      <table class="table table-striped">
        <thead class="thead-light">
          <tr>
            <th>Vorname</th>
            <th>Nachname</th>
            <th>Menge</th>
            <th>Gericht</th>
            <th>Fleisch</th>
            <th>Ohne So√üe</th>
            <th>Ohne Tomate</th>
            <th>Mit Scharf</th>
            <th>Mit Schafsk√§se</th>
            <th>Getr√§nk</th>
            <th>Preis</th>
            <th>Datum</th>
            <th>Bezahlt</th>
            <th>Aktion</th>
          </tr>
        </thead>
        <tbody id="order-list"></tbody>
      </table>

      <div id="total-price-container" class="text-right">
        <h4>Gesamtpreis aller Bestellungen: <span id="total-price">0 ‚Ç¨</span></h4>
      </div>

      <h3 class="mt-5">üì¶ Artikel-Zusammenfassung</h3>
      <table class="table table-striped">
        <thead class="thead-light">
          <tr>
            <th>Gericht</th>
            <th>Fleisch</th>
            <th>Mit Schafsk√§se</th>
            <th>Mit Scharf</th>
            <th>Ohne So√üe</th>
            <th>Ohne Tomate</th>
            <th>Gesamtmenge</th>
          </tr>
        </thead>
        <tbody id="summary-list"></tbody>
      </table>

      <h3 class="mt-4">ü•§ Getr√§nke-Zusammenfassung</h3>
      <table class="table table-striped">
        <thead class="thead-light">
          <tr>
            <th>Getr√§nk</th>
            <th>Anzahl</th>
          </tr>
        </thead>
        <tbody id="drink-summary-list"></tbody>
      </table>

      <h3 class="mt-5">üìú Alle Bestellungen</h3>
      <table class="table table-striped">
        <thead class="thead-light">
          <tr>
            <th>Vorname</th>
            <th>Nachname</th>
            <th>Menge</th>
            <th>Gericht</th>
            <th>Fleisch</th>
            <th>Getr√§nk</th>
            <th>Preis</th>
            <th>Datum</th>
            <th>Bezahlt</th>
            <th>Aktion</th>
          </tr>
        </thead>
        <tbody id="order-list-all"></tbody>
      </table>

    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    const backendUrl = location.hostname === "localhost"
      ? "http://localhost:3000"
      : "https://haaslan.onrender.com";

    function checkPassword() {
      const password = document.getElementById("password").value;
      const storedPassword = localStorage.getItem("adminPassword");

      if ((storedPassword && storedPassword === "Haaslan") || password === "Haaslan") {
        localStorage.setItem("adminPassword", "Haaslan");
        document.getElementById("password-screen").style.display = "none";
        document.getElementById("admin-content").style.display = "block";
        fetchOrders();
      } else {
        alert("Falsches Passwort.");
      }
    }

    function deleteOrder(orderId) {
      $.ajax({
        url: `${backendUrl}/delete-order/${orderId}`,
        method: 'DELETE',
        success: fetchOrders,
        error: () => alert('Fehler beim L√∂schen.')
      });
    }

    function markAsPaid(orderId) {
      $.ajax({
        url: `${backendUrl}/set-paid/${orderId}`,
        method: 'PUT',
        success: fetchOrders,
        error: () => alert("Fehler beim Setzen auf 'bezahlt'.")
      });
    }

    function fetchOrders() {
      $.ajax({
        url: `${backendUrl}/get-orders`,
        method: 'GET',
        success: function (data) {
          const today = new Date().toISOString().slice(0, 10);
          const orderListToday = $('#order-list');
          const orderListAll = $('#order-list-all');
          const summaryList = $('#summary-list');
          const drinkSummaryList = $('#drink-summary-list');
          let totalPrice = 0;
          const summaryMap = {};
          const drinkMap = {};

          orderListToday.empty();
          orderListAll.empty();
          summaryList.empty();
          drinkSummaryList.empty();

          data.orders.forEach(order => {
            const paid = order.paid ? '‚úÖ' : '‚ùå';
            const ohneSo√üe = order.ohne_so√üe ? 'X' : '';
            const ohneTomate = order.ohne_tomate ? 'X' : '';
            const mitScharf = order.mit_scharf ? 'X' : '';
            const mitSchafsk√§se = order.mit_schafsk√§se ? 'X' : '';

            const row = `
              <tr>
                <td>${order.firstname}</td>
                <td>${order.lastname}</td>
                <td>${order.quantity}</td>
                <td>${order.food_choice}</td>
                <td>${order.meat_choice}</td>
                <td>${order.drink}</td>
                <td>${order.total_price} ‚Ç¨</td>
                <td>${order.created_at}</td>
                <td>${paid}</td>
                <td>
                  <button class="btn btn-success btn-sm" onclick="markAsPaid(${order.id})">Paid</button>
                  <button class="btn btn-danger btn-sm delete-order" data-id="${order.id}">L√∂schen</button>
                </td>
              </tr>
            `;

            orderListAll.append(row);

            if (order.created_at?.startsWith(today)) {
              orderListToday.append(`
                <tr>
                  <td>${order.firstname}</td>
                  <td>${order.lastname}</td>
                  <td>${order.quantity}</td>
                  <td>${order.food_choice}</td>
                  <td>${order.meat_choice}</td>
                  <td>${ohneSo√üe}</td>
                  <td>${ohneTomate}</td>
                  <td>${mitScharf}</td>
                  <td>${mitSchafsk√§se}</td>
                  <td>${order.drink}</td>
                  <td>${order.total_price} ‚Ç¨</td>
                  <td>${order.created_at}</td>
                  <td>${paid}</td>
                  <td>
                    <button class="btn btn-success btn-sm" onclick="markAsPaid(${order.id})">Paid</button>
                    <button class="btn btn-danger btn-sm delete-order" data-id="${order.id}">L√∂schen</button>
                  </td>
                </tr>
              `);

              totalPrice += parseFloat(order.total_price);

              const key = [
                order.food_choice,
                order.meat_choice,
                order.mit_schafsk√§se ? 'mit Schafsk√§se' : '',
                order.mit_scharf ? 'mit Scharf' : '',
                order.ohne_so√üe ? 'ohne So√üe' : '',
                order.ohne_tomate ? 'ohne Tomate' : ''
              ].join('|');

              if (!summaryMap[key]) {
                summaryMap[key] = {
                  food: order.food_choice,
                  meat: order.meat_choice,
                  mit_schafsk√§se: order.mit_schafsk√§se,
                  mit_scharf: order.mit_scharf,
                  ohne_so√üe: order.ohne_so√üe,
                  ohne_tomate: order.ohne_tomate,
                  quantity: 0
                };
              }
              summaryMap[key].quantity += order.quantity;

              const drink = order.drink?.trim();
              if (drink) {
                drinkMap[drink] = (drinkMap[drink] || 0) + order.quantity;
              }
            }
          });

          Object.values(summaryMap).forEach(entry => {
            summaryList.append(`
              <tr>
                <td>${entry.food}</td>
                <td>${entry.meat}</td>
                <td>${entry.mit_schafsk√§se ? 'X' : ''}</td>
                <td>${entry.mit_scharf ? 'X' : ''}</td>
                <td>${entry.ohne_so√üe ? 'X' : ''}</td>
                <td>${entry.ohne_tomate ? 'X' : ''}</td>
                <td>${entry.quantity}</td>
              </tr>
            `);
          });

          Object.entries(drinkMap).forEach(([drink, count]) => {
            drinkSummaryList.append(`<tr><td>${drink}</td><td>${count}</td></tr>`);
          });

          $('#total-price').text(`${totalPrice.toFixed(2)} ‚Ç¨`);
        },
        error: () => alert('Fehler beim Abrufen der Bestellungen.')
      });
    }

    $(document).ready(function () {
      const storedPassword = localStorage.getItem("adminPassword");
      if (storedPassword === "Haaslan") {
        document.getElementById("password-screen").style.display = "none";
        document.getElementById("admin-content").style.display = "block";
        fetchOrders();
      }

      $(document).on('click', '.delete-order', function () {
        const orderId = $(this).data('id');
        deleteOrder(orderId);
      });
    });
  </script>

</body>
</html>
