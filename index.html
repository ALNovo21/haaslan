<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HPC - Haaslan Product Configurator</title>

  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* ----------- LOGIN / SIGNUP SCREEN (standardmäßig sichtbar) ----------- */
    #auth-box {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      background: #ffffff;
      z-index: 99999;
      display: flex;              /* <-- Sichtbar per Default */
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 30px;
    }
    #auth-box .card {
      width: 320px;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    #auth-box input, #auth-box button {
      margin: 6px 0;
      border-radius: 10px;
    }

    /* ----------- MAIN CONTENT (standardmäßig versteckt) ----------- */
    #main-content {
      display: none;              /* <-- Versteckt per Default */
    }

    /* ----------- SIDEBAR ----------- */
    .sidebar {
      height: 100%;
      width: 250px;
      position: fixed;
      top: 0;
      left: -250px;
      background-color: #343a40;
      color: white;
      padding: 20px;
      transition: 0.3s;
      z-index: 1050;
    }
    .sidebar.active { left: 0; }
    .sidebar a {
      color: white;
      display: block;
      padding: 10px 0;
      font-size: 18px;
      text-decoration: none;
    }
    .sidebar a:hover { background-color: #575757; }
    body.sidebar-active { margin-left: 250px; }

    /* ----------- HEADER ----------- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #007bff;
      color: white;
      padding: 15px;
      border-radius: 10px 10px 0 0;
    }

    /* ----------- ORDER PREVIEW ----------- */
    .order-preview {
      border-radius: 10px;
      border: 1px solid #ddd;
      padding: 15px;
    }
  </style>
</head>
<body>

  <!-- ✅ AUTH SCREEN -->
  <div id="auth-box">
    <div class="card p-4">
      <h3 class="mb-3 text-center">Einloggen</h3>
      <input id="email" class="form-control" placeholder="Email">
      <input id="password" class="form-control" type="password" placeholder="Passwort">
      <button class="btn btn-primary btn-block" onclick="signin()">Einloggen</button>

      <hr>

      <h5 class="mt-2 mb-2 text-center">Oder registrieren</h5>
      <input id="name" class="form-control" placeholder="Name">
      <input id="email-signup" class="form-control" placeholder="Email">
      <input id="password-signup" class="form-control" type="password" placeholder="Passwort">
      <button class="btn btn-success btn-block" onclick="signup()">Registrieren</button>
    </div>
  </div>

  <!-- ✅ SIDEBAR -->
  <div id="sidebar" class="sidebar">
    <a href="myorders.html">Meine Bestellungen</a>
    <h4>Admin Menü</h4>
    <a href="admin.html">Admin Ansicht</a>
  </div>

  <!-- ✅ MAIN CONTENT (wird erst nach Auth sichtbar) -->
  <div id="main-content" class="container">
    <div class="header">
      <h1>HPC - Haaslan Product Configurator</h1>
      <div>
        <button id="sidebar-toggle" class="btn btn-light mr-2" onclick="toggleSidebar()">☰</button>
        <button id="logout-btn" class="btn btn-outline-light" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6">
        <!-- ✅ ORDER FORM -->
        <div class="card p-4">
          <h3>Bestellung hinzufügen</h3>
          <form id="order-form">
            <div class="form-group">
              <label for="firstname">Vorname</label>
              <input type="text" class="form-control" id="firstname" required>
            </div>

            <div class="form-group">
              <label for="lastname">Nachname</label>
              <input type="text" class="form-control" id="lastname" required>
            </div>

            <div class="form-group">
              <label for="food-choice">Gericht</label>
              <select class="form-control" id="food-choice" required>
                <option value="Kebap">Kebap (6€)</option>
                <option value="Dürum">Dürüm (6,50€)</option>
                <option value="Kebap-Box">Kebap-Box (7€)</option>
              </select>
            </div>

            <div class="form-group">
              <label for="meat-choice">Fleisch</label>
              <select class="form-control" id="meat-choice" required>
                <option value="Huhn">Huhn</option>
                <option value="Kalb">Kalb</option>
              </select>
            </div>

            <div class="form-group">
              <label for="quantity">Menge</label>
              <input type="number" class="form-control" id="quantity" min="1" value="1" required>
            </div>

            <div class="form-group">
              <label>Extras</label><br>
              <label><input type="checkbox" id="extra-no-tomato"> Ohne Tomate</label><br>
              <label><input type="checkbox" id="extra-no-sauce"> Ohne Soße</label><br>
              <label><input type="checkbox" id="extra-with-cheese"> Mit Schafskäse +1€</label><br>
              <label><input type="checkbox" id="extra-spicy"> Scharf</label><br>
              <label><input type="checkbox" id="extra-no-onion"> Ohne Zwiebel</label><br>
              <label><input type="checkbox" id="extra-only-salad"> Nur Salat</label><br>
              <label><input type="checkbox" id="extra-extra-sauce"> Extra Soße</label><br>
            </div>

            <div class="form-group">
              <label for="drink-choice">Getränk</label>
              <select class="form-control" id="drink-choice">
                <option value="">Kein Getränk</option>
                <option value="Ayran">Ayran +2€</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary">Bestellung hinzufügen</button>
          </form>
        </div>
      </div>

      <div class="col-md-6">
        <div class="order-preview">
          <h3>Bestellvorschau</h3>
          <div id="order-preview"><p>Keine Bestellungen.</p></div>
          <button id="submit-orders" class="btn btn-success mt-3" style="display:none;">Bestellung abschicken</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    /* --------------------------- UI TOGGLER --------------------------- */
    function showAuth() {
      document.getElementById('auth-box').style.display = 'flex';
      document.getElementById('main-content').style.display = 'none';
    }
    function showMain() {
      document.getElementById('auth-box').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
    }

    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("active");
      document.body.classList.toggle("sidebar-active");
    }

    /* --------------------------- AUTH CHECK --------------------------- */
    async function checkAuth() {
      try {
        // Entscheidend: Nur wenn 200 OK -> Main zeigen
        const res = await fetch(`${API}/myorders`, { credentials: "include" })

        if (res.ok) {
          showMain();
        } else {
          showAuth();
        }
      } catch (e) {
        // Netzwerk-/CORS-/404-Fehler -> als nicht eingeloggt behandeln
        showAuth();
      }
    }

    /* --------------------------- SIGNUP / SIGNIN --------------------------- */
    async function signup() {
      const res = await fetch(`${API}/signup`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        credentials: "include",
        body: JSON.stringify({
          name: document.getElementById("name").value,
          email: document.getElementById("email-signup").value,
          password: document.getElementById("password-signup").value
        })
      });
      const data = await res.json().catch(() => ({}));
      if (res.ok && data.success) {
        alert("Registrierung erfolgreich! Bitte einloggen.");
      } else {
        alert(data.error || "Registrierung fehlgeschlagen.");
      }
    }

    async function signin() {
      const res = await fetch("/signin", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        credentials: "include",
        body: JSON.stringify({
          email: document.getElementById("email").value,
          password: document.getElementById("password").value
        })
      });
      const data = await res.json().catch(() => ({}));
      if (res.ok && data.success) {
        // Direkt anzeigen – kein Reload nötig
        showMain();
      } else {
        alert(data.error || "Login fehlgeschlagen.");
      }
    }

    async function logout() {
      // Optional: falls du im Backend /logout implementierst, wird hier der Cookie gelöscht.
      // Ohne Backend-Logout: wir zeigen einfach wieder den Auth-Screen.
      try {
        await fetch("/logout", { method: "POST", credentials: "include" });
      } catch(e) {}
      showAuth();
    }

    /* --------------------------- ORDER LOGIC --------------------------- */
    let orders = [];

    function calculatePrice(order) {
      let base = order.foodChoice === "Kebap" ? 6 :
                 order.foodChoice === "Dürüm" ? 6.5 : 7;
      let extras = 0;
      if (order.extra_with_cheese) extras += 1;
      if (order.drinkChoice === "Ayran") extras += 2;
      return (base + extras).toFixed(2);
    }

    $('#order-form').on('submit', function (e) {
      e.preventDefault();

      const order = {
        firstname: $('#firstname').val(),
        lastname: $('#lastname').val(),
        foodChoice: $('#food-choice').val(),
        meatChoice: $('#meat-choice').val(),
        quantity: parseInt($('#quantity').val(), 10),
        extra_no_tomato: $('#extra-no-tomato').is(':checked'),
        extra_no_sauce: $('#extra-no-sauce').is(':checked'),
        extra_with_cheese: $('#extra-with-cheese').is(':checked'),
        extra_spicy: $('#extra-spicy').is(':checked'),
        extra_no_onion: $('#extra-no-onion').is(':checked'),
        extra_only_salad: $('#extra-only-salad').is(':checked'),
        extra_extra_sauce: $('#extra-extra-sauce').is(':checked'),
        drinkChoice: $('#drink-choice').val(),
      };

      order.price = calculatePrice(order);
      orders.push(order);
      updatePreview();
    });

    function updatePreview() {
      const box = $('#order-preview');
      box.empty();

      if (orders.length === 0) {
        box.append("<p>Keine Bestellungen.</p>");
        $('#submit-orders').hide();
        return;
      }

      orders.forEach((o, i) => {
        const total = (parseFloat(o.price) * o.quantity).toFixed(2);
        box.append(`
          <div class="mb-3 p-2 border rounded">
            <div><strong>${o.foodChoice} (${o.meatChoice}) – ${o.quantity}x</strong></div>
            <div>Einzelpreis: €${o.price} | Gesamt: €${total}</div>
            <button class="btn btn-danger btn-sm mt-2" onclick="removeOrder(${i})">Löschen</button>
          </div>
        `);
      });

      $('#submit-orders').show();
    }

    function removeOrder(i) {
      orders.splice(i, 1);
      updatePreview();
    }

    $('#submit-orders').on('click', function () {
      if (orders.length === 0) {
        alert('Keine Bestellungen vorhanden.');
        return;
      }
      $.ajax({
        url: '/submit-orders',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(orders),
        xhrFields: { withCredentials: true },
        success: function () {
          alert('Bestellung wurde erfolgreich abgeschickt!');
          orders = [];
          updatePreview();
        },
        error: function () {
          alert('Fehler beim Absenden der Bestellung.');
        }
      });
    });

    /* Start: Auth prüfen, danach UI setzen */
    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
</body>
</html>
